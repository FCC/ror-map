<!DOCTYPE html>

<html class="no-js" lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="description" content="E-rate Schools">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Rate of Return Map Â« FCC</title>
<link rel="shortcut icon" href="img/fcc_favicon.ico" type="image/x-icon">
<link href='http://maxcdn.bootstrapcdn.com/bootstrap/3.3.2/css/bootstrap.min.css' rel='stylesheet' />
<link rel="stylesheet" href="css/app-theme.css">

<style type="text/css">
    html, body { width: 100%; height: 100%; padding: 0; margin: 0; }
    main { margin-top: 20px; }
    #map { height: 600px; top: 0; bottom: 0; max-width: 100%; width: 100%; }
    .btn-baselayer-control {
        margin-right: 3px;
        width: 100px;
        height: 25px;
        background-color: #FFFFFF;    
        font-family: Arial;    
        border-radius: 3px;
        color: #000000;
        cursor: pointer;
        font-weight: normal;
        border: solid 1px #CCCCCC;
        outline:none;
    }
    .btn-baselayer-control-selected {
        font-weight: bold;
        border: solid 2px #777777;
        outline:none;
    }

    .ui-icon {
        zoom: 1.0;
}

</style>

<!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
      <script src="js/libs/selectivizr-min.js"></script>
    <![endif]-->

</head>
<body>
<header>
    <nav class="container" role="navigation">
        <div class="row">
            <div class="col-xs-10 col-sm-9"> <a href="http://www.fcc.gov/"><img class="logo" src="img/logo-fcc.png" alt="Go to the Federal Communications Commission homepage at www.fcc.gov" title="Go to the Federal Communications Commission homepage at www.fcc.gov"></a>
                <h1>Rate of Return Map</h1>
            </div>
            <div class="col-xs-2 col-sm-3"> <a class="pull-right" href="javascript: void(0);" data-toggle="modal" data-target="#modal-about"><span class="icon-help-2"></span><span class="sr-only">About/Help</span></a> </div>
        </div>
    </nav>
</header>
<main class="container">
    <div class="row">
        
            <div class="col-md-9">
                <form >
                    <div id="search-field" class="input-group" style="margin-bottom: 10px;">
                        <input id="input-location" class="form-control" type="search" placeholder="Enter Location">
                        <span class="input-group-btn">
                        
                        <button class="btn btn-default" type="submit" id="input-search" title="Search"><span class="glyphicon glyphicon-search"></span><span class="sr-only">Search</span></button>

                        </span> </div>
                </form>
                <div class="map-container">
					<button title="Get Current Location" data-placement="right" data-toggle="tooltip" id="btn-geoLocation" type="button" class="btn-geoLocation btn btn-default st" data-original-title="Get Current Location"><span class="icon-locate-1"></span><span class="sr-only">Get Current Location</span></button>
					<button title="Nationwide" data-placement="right" data-toggle="tooltip" id="btn-nationLocation" type="button" class="btn-nationLocation btn btn-default st" data-original-title="Nationwide"><span class="icon-nation-1"></span><span class="sr-only">Nationwide</span></button>
					<div id="map">

                        <!-- tooltip box -->
                        <div class="col-md-3" id="tooltip_box_div" style="position: absolute; height: 70px; bottom: 22px; right: 0px; z-index: 999">
                            <div id="feature_display_div" class="panel panel-default" style="margin: 0px; height: 100%; width: 100%; padding: 10px;  border: solid 1px #000">
                            </div>
                        </div>

                        <div style="position: absolute; z-index: 1001; top: 10px; left: 100px;">
                            <button id="btn-street" class="btn-baselayer-control btn-baselayer-control-selected">Street Map</button>
                            <button id="btn-satellite" class="btn-baselayer-control">Satellite</button>
                            <button id="btn-topo" class="btn-baselayer-control">Terrain</button>
                        </div>


                        <div id="download-btn-small" style="position: absolute; width: 28px; height: 28px; top: 50px; right: 10px; background-color: #ffffff; border: solid 1px #888888; border-radius: 3px; text-align: center; padding: 5px; cursor: pointer; z-index: 1" onclick="showDownloadMenuBox()" title="Download Data">
                        <span class="ui-icon ui-icon-circle-arrow-s"></span>
                        </div>                                                

                        <div id="download-menu-box"  style="position: absolute; width: 400px; top: 50px; right: 10px; background-color: #ffffff; border: solid 1px #888888; border-radius: 3px; text-align: center; padding: 5px; display: none; cursor: pointer; z-index: 1">
                            <span class="ui-icon ui-icon-closethick" onclick="hideDownloadMenuBox()" style="float: right; cursor: default"></span>
                            <p>
                            <select id="download_select"><option value="">--data type--</option><option value="shapefile">Shapefile</option><option value="geojson">GeoJSON</option><option value="kml">KML</option><option value="csv">CSV</option></select> &nbsp;
                            <input type="radio" name="download-type" value="area" checked>One Area
                            <input type="radio" name="download-type" value="all">All Areas
                            &nbsp;&nbsp;<button id="btn-download" title="click to download"><span class="ui-icon ui-icon-circle-triangle-e"></span></button>
                            <p>
                            <span id="area-display" style="font-size: 12px;"></span>
                            <p>
                            <span id="warning-display" style="font-size: 12px; color: #f00">Please click on map to select an area to download</span>
                            
                        </div>

                        <div id="legend-btn-small" style="position: absolute; width: 28px; height: 28px; bottom: 70px; left: 5px; background-color: #ffffff; border: solid 1px #888888; border-radius: 3px; text-align: center; padding: 5px; cursor: pointer; z-index: 1" onclick="showMapLegendBox()" title="Map Legend">
                        <span class="ui-icon ui-icon-note"></span>
                        </div> 

                        <div id="map-legend-box"  style="position: absolute; width: 150px; height: 165px; bottom: 70px; left: 5px; background-color: #eee; border: solid 1px #888888; border-radius: 5px; text-align: left; padding: 5px; display: none; cursor: default; z-index: 1">
                            <span class="ui-icon ui-icon-note" style="float: left"> </span> &nbsp; <span style="float: left; color: #000">Map Legend</span>   <span class="ui-icon ui-icon-closethick" onclick="hideMapLegendBox()" style="float: right; cursor: default"></span>
                            <p>
                            <p>
                            <table>
                            <tr><td><div style="width: 25px; height: 25px; background-color: #b0e27a; border: solid 2px #000; display: inline-block;"></div></td> <td style="vertical-align: center; padding: 10px;"> SAC Areas </td></tr>
                            <tr><td><div style="width: 25px; height: 25px; background-color: #b0e27a; border: solid 1px #fff; display: inline-block;"></div></td><td style="vertical-align: center; padding: 10px;"> SA Areas </td></tr>
                            <tr><td style="text-align: center"><div style="width: 15px; height: 15px; background-color: #fff; border: solid 1px #000; display: inline-block; border-radius: 20px;"></div></td><td style="vertical-align: center; padding: 10px;">Central Offices </td></tr>
                            </table>

                        </div>

                    </div>

				</div>
            </div>

           
       
    </div>
</main>

<div id="display"></div>


<footer>
    <div class="container">
        <div class="row">
            <div class="col-md-12"> <em>*** Non-Public:  For Internal Use Only ***</em> </div>
        </div>
    </div>
</footer>




<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> 
<script>window.jQuery || document.write('<script src="js/vendor/jquery-1.11.0.min.js"><\/script>')</script> 
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script> 
<script src="https://code.jquery.com/ui/1.11.4/jquery-ui.js"></script>
<link href="http://code.jquery.com/ui/1.10.4/themes/ui-lightness/jquery-ui.css" rel="stylesheet">
<script src='https://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.js'></script>
<link href='http://api.tiles.mapbox.com/mapbox.js/v2.1.4/mapbox.css' rel='stylesheet' />
<script src='https://api.tiles.mapbox.com/mapbox.js/plugins/leaflet-pip/v0.0.2/leaflet-pip.js'></script>


<script type="text/javascript">

    var map;
    var shownPolygon;
    var clickedPolygon;
    var dataNow = {"totalFeatures": 0};
    var dataCredential = {};
    var xNow;
    var yNow;

    var drawnPolygonOption = {
        'color': '#fff',
        'fillColor': '#000',
        'weight': 3,
        'fillOpacity': 0.5
    }

    var clickedPolygonOption = {
        'color': '#000',
        'fillColor': '#fff',
        'weight': 3,
        'fillOpacity': 0.5
    }

    var southWest = L.latLng(24.525841, -126.597970),
        northEast = L.latLng(50.957531, -64.722975),
        bounds_us = L.latLngBounds(southWest, northEast);

    function createMap() {
        L.mapbox.accessToken = 'pk.eyJ1IjoiY29tcHV0ZWNoIiwiYSI6InMyblMya3cifQ.P8yppesHki5qMyxTc2CNLg';
        map = L.mapbox.map('map', 'nbm.i2op87g0', { attributionControl: true, maxZoom: 11})
            .fitBounds(bounds_us);

        //custom attrbution
        //var credits = L.control.attribution().addTo(map);
        //credits.addAttribution('Credits: FCC');

        baseStreet = L.mapbox.tileLayer('computech.j86bnb99').addTo(map);
        baseSatellite = L.mapbox.tileLayer('computech.jh7ic2j0');
        baseTerrain = L.mapbox.tileLayer('computech.jh7ih1gk');

        var wms_ror_service_areas = L.tileLayer.wms('http://ldevtm-geo02:8080/geoserver/wms', {
            format: 'image/png',
            transparent: true,
            layers: 'geo_swat:ror_service_areas'
        });

        var wms_ror_service_areas_sac = L.tileLayer.wms('http://ldevtm-geo02:8080/geoserver/wms', {
            format: 'image/png',
            transparent: true,
            layers: 'geo_swat:ror_service_areas_sac'
        });

        var wms_ror_central_offices = L.tileLayer.wms('http://ldevtm-geo02:8080/geoserver/wms', {
            format: 'image/png',
            transparent: true,
            layers: 'geo_swat:ror_central_offices'
        });


        L.control.scale().addTo(map);

        geocoder = L.mapbox.geocoder('mapbox.places-v1');

        L.control.layers({

        },
        {
            'Service Areas SA': wms_ror_service_areas.addTo(map),
            'Service Areas SAC': wms_ror_service_areas_sac.addTo(map),
            'Central Offices':  wms_ror_central_offices.addTo(map)
        }
        ).addTo(map);

        // var gridLayer = L.mapbox.gridLayer('fcc.7zcvriap', {'follow': true});
        // map.addLayer(gridLayer);
        // map.addControl(L.mapbox.gridControl(gridLayer));

        //map.addControl(L.mapbox.geocoderControl('mapbox.places').setPosition('topleft'))

        //wms_ror_service_areas.addTo(map);

        map.on("mousemove", function(e){

            var lat = e.latlng.lat;
            var lng = e.latlng.lng;

            var url = "http://ldevtm-geo02:8080/geoserver/geo_swat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geo_swat:ror_service_areas&maxFeatures=1&outputFormat=text/javascript&cql_filter=contains(geom,%20POINT(" + lng + " " + lat + "))";

            isInsideDrawnPolygon = false;
            if (map.hasLayer(shownPolygon)) {
                 var results = leafletPip.pointInLayer([lng, lat], shownPolygon);
                if (results.length > 0) {
                    isInsideDrawnPolygon = true;
                }
            }

            if (isInsideDrawnPolygon) {
                return;
            }

            //$("#display").html(isInsideDrawnPolygon + ' ' +  url)

            $.ajax({
                type: "GET",
                url: url,
                dataType: "jsonp",
                jsonpCallback: "parseResponse",
                success: function(data) {
                    displayPolygon(data);
                }
            });
        });

        $(function() {
            var icons = {
            header: "ui-icon-circle-arrow-e",
            activeHeader: "ui-icon-circle-arrow-s"
            };
            $download_accordion =  $("#download_display_div").accordion({
                icons: icons,
                collapsible: true,
                heightStyle: "content",
                active: false
            });
        });


       //  $("#download-btn").button({
       //     icons: {
       //         primary: "ui-icon-locked"
       //     }
       // });

    }


    $('#btn-street').on('click', function(e) {
        e.preventDefault();
        changeBaseLayer('street');
    }); 
    $('#btn-satellite').on('click', function(e) {
        e.preventDefault()
        changeBaseLayer('satellite');
    });
    $('#btn-topo').on('click', function(e) {
        e.preventDefault();
        changeBaseLayer('topo');
    });
  
    function changeBaseLayer(type) {   
    
        map.removeLayer(baseStreet);
        map.removeLayer(baseSatellite);
        map.removeLayer(baseTerrain);

        if (type == 'street') {
            baseStreet.addTo(map);
            toggleClass(type);
        }
        if (type == 'satellite') {
            baseSatellite.addTo(map);
            toggleClass(type);
        }
        if (type == 'topo') {
            baseTerrain.addTo(map);
            toggleClass(type);
        }

        


    }

    function toggleClass(type) {
    
        $('#btn-street').removeClass('btn-baselayer-control-selected');
        $('#btn-satellite').removeClass('btn-baselayer-control-selected');
        $('#btn-topo').removeClass('btn-baselayer-control-selected');       
        
        $('#btn-' + type).addClass('btn-baselayer-control-selected');
    }







    function displayPolygon(data) {
        dataNow = data;

        if (map.hasLayer(shownPolygon)) {
        map.removeLayer(shownPolygon)
        }

        if (dataNow.totalFeatures == 0) {
            $("#tooltip_box_div").hide();
             return;
         }

        shownPolygon = L.mapbox.featureLayer(data).setStyle(drawnPolygonOption).addTo(map);
        shownPolygon.on("click", function(e) {
            clickPolygon(e);
        });


        dataNow = data;
        shownPolygon.setZIndex(999);
        var text = "SAC:" + dataNow.features[0].properties.sac + "<br> SA:" + dataNow.features[0].properties.sa + "<br>SOURCE: " + dataNow.features[0].properties.node0sourc + "<p>";

        $("#feature_display_div").html(text);
        $("#tooltip_box_div").show();
    }

    function clickPolygon(e) {

        // var text = "SAC:" + dataNow.features[0].properties.sac + "<br> SA:" + dataNow.features[0].properties.sa + "<br>SOURCE: " + dataNow.features[0].properties.node0sourc + "<p>";
        // $("#selected_area_desc").html(text);
        // $("#download_menu_div").show();
        // $("#download_display_div").accordion('option', {active: true});

        if (map.hasLayer(clickedPolygon)) {
            map.removeLayer(clickedPolygon);
        }
        clickedPolygon = L.mapbox.featureLayer(dataNow).setStyle(clickedPolygonOption).addTo(map);
        dataCredential = {"sac": dataNow.features[0].properties.sac, "sa": dataNow.features[0].properties.sa, "node0sourc": dataNow.features[0].properties.node0sourc};

        var text = "[Selected Area] SAC: " + dataCredential.sac + " SA: " + dataCredential.sa + " SOURCE:" + dataCredential.node0sourc;
        $("#area-display").html(text);
        $("#warning-display").html("");

    }


    function setListener() {

        $("#input-search").on("click", function(e){
            e.preventDefault();
			locChange();
        });


        $('#btn-geoLocation').click(function (event) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(function (position) {
                    var geo_lat = position.coords.latitude;
                    var geo_lon = position.coords.longitude;
                    var geo_acc = position.coords.accuracy;

                    map.setView([geo_lat, geo_lon], 12);

                }, function (error) {
                    //alert('Error occurred. Error code: ' + error.code);    
                    alert('Sorry, your current location could not be found. \nPlease use the search box to enter your location.');
                }, { timeout: 4000 });
            }
            else {
                alert('Sorry, your current location could not be found. \nPlease use the search box to enter your location.');
            }

            return false;
        });



        $("#btn-nationLocation").on("click", function(){
            map.fitBounds(bounds_us);
        });

        $("#map").on("mousemove", function(e) {
            xNow = e.pageX;
            yNow = e.pageY;
            ("#display").html(xNow + ' ' + yNow)
        });

        $("#x-download").on("click", function(e) {
            $("#download_display_div").hide();
        });

        $("#btn-download").on("click", function(e) {
            e.preventDefault();
            downloadData();
        });

        $("#download_select").on("change", function(e) {
            e.preventDefault();
            $("#warning-display").html("");
        });

        $("input[name=download-type]").on("change", function(e) {
            e.preventDefault();
            var downloadType = $('input[name=download-type]:checked').val();
            if (downloadType == "all") {
                $("#warning-display").html("This will download data for all areas in one file");
            }
            else {
                if (dataCredential.sac == undefined) {
                    $("#warning-display").html("Please click on map to select an area to download");
                }
                else {
                    $("#warning-display").html("This will download data for the selected area");
                }
            }
            
        });



    }

    function downloadData() {
        var downloadType = $('input[name=download-type]:checked').val();
        var sac = dataCredential.sac;
        var sa = dataCredential.sa;
        var node0sourc = dataCredential.node0sourc;

        if (downloadType == "area" && sac == undefined) {
            var text = "Please click on map to select an area";
            $("#warning-display").html(text);
            return;
        }

        var dataType = $("#download_select").val();
        if (dataType == "") {
            var text = "Please select a data type";
            $("#warning-display").html(text);
            return;
        }
        else {
            if (dataType == "shapefile") {
                format = "shape-zip";
            }
            if (dataType == "geojson") {
                format = "application/json";
            }
            if (dataType == "kml") {
                format = "kml";
            }
            if (dataType == "csv") {
                format = "csv"
            }

            if (downloadType == "area") {
                var url = "http://ldevtm-geo02:8080/geoserver/geo_swat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geo_swat:ror_service_areas&maxFeatures=50&outputFormat=" + format + "&cql_filter=sac='" + sac + "'+AND+sa='" + sa + "'+AND+node0sourc='" + node0sourc + "'";
            }
            else {
                var url = "http://ldevtm-geo02:8080/geoserver/geo_swat/ows?service=WFS&version=1.0.0&request=GetFeature&typeName=geo_swat:ror_service_areas&maxFeatures=10000&outputFormat=" + format;
            }

            window.open(url, config="toolbar=0");
        }


    }



    function locChange() {

        var loc = $("#input-location").val();


        geocoder.query(loc, codeMap);
    }

    function codeMap(err, data) {
        //alert(JSON.stringify(data));

        var lat = data.latlng[0];
        var lon = data.latlng[1];

        if (data.lbounds) {
            map.fitBounds(data.lbounds);
        }

        else if (data.latlng) {
            map.setView([lat, lon], 15);
        }
    }

    function showDownloadMenuBox() {
        $("#download-menu-box").show()
    }

    function hideDownloadMenuBox() {
        $("#download-menu-box").hide()
    }

    function showMapLegendBox() {
        $("#map-legend-box").show()
    }

    function hideMapLegendBox() {
        $("#map-legend-box").hide()
    }

    $(document).ready(function(){
        createMap();
        setListener();
    });

</script>


</body></html>